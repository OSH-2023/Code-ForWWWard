
# ROS2基于DCA技术优化实时性的可行性报告

## 目录

## 小组成员

* 王润泽

* 王道宇

* 封霁芩

* 陈应豪

* 王昱
## 项目背景：ROS2通信框架的实时性问题
### 实时性和低延迟通信的要求
//TODO: wdy
### ROS2在Linux系统上实时性的瓶颈
* `Linux`**内核的实时性不足**：`Linux`内核的调度机制并不是针对实时性的，这使得`Linux`无法提供完全实时的响应

### ROS2通信框架的性能瓶颈
* `ROS2`使用通用的通信框架，它的设计并不是专门为实时性而优化的。`ROS2`使用`DDS`作为通信协议，`DDS`是一种高度灵活的通信协议，但其对实时性能的支持并不足够强大

* **CPU资源占用**：需要占用CPU资源进行消息的序列化、反序列化、传输等操作，如果CPU资源占用过高，则会影响实时性能
* **内存管理**：涉及到内存的动态分配和释放，如果内存管理不当，会导致内存碎片问题，从而影响实时性能

> 因此我们需要引入DCA技术来大大提高ROS2的实时性

## 理论支撑

### ROS2通信框架及其应用
wy
//TODO:调研报告

### NIC与CPU交互模式

网卡(Network Interface Card，简称NIC)，也称网络适配器，是电脑与局域网相互连接的设备。

#### Ring-based Model

初始化时，处理器在内存中为传入和传出的数据包分配缓冲区。它在描述符中记录缓冲区的属性(例如，它们的基址和长度)，并将这些描述符存储在两个环中，一个用于发送(TX)，另一个用于接收(RX)。

![](./research%20by%20fjq/src/ring-based-model.png)

- 当数据包到达时：
  - S2:NIC读取环头指向的描述符以获取空缓冲区，将数据包内容写入缓冲区，并更新描述符以记录数据包的属性。
  - S3:向处理器发送中断，以通知数据包的到达。
  - S4:处理器通过中断或对尾指针所指向的描述符进行忙轮询来得到通知。它给出一个新的描述符，指向RX环的空缓冲区，移动尾指针，并将接收到的缓冲区移交给应用程序。
- 发送数据包时：
  - S5: 一旦处理程序完成，驱动程序在head指针指向的空TX描述符上申请缓冲区，并移动指针提示NIC
  - S6: NIC读取TX描述符，获取缓冲区，并将其内容发送到线路，移动TX尾以指示数据包发送完成
  - S7: 驱动定期检查TX环以回收已发送的缓冲区

NIC与处理器有多种交换数据信息的模式，包括中断、内存映射IO (MMIO)和直接内存访问(DMA)。
### igb

//TODO:fjq

### DMA与DCA技术介绍

 DMA (Direct Memory Access)技术，其基本思想是外设和 RAM 之间开辟直接的数据传输通路。一般情况下，总线所有的工作周期（总线周期）都用于 CPU 执行程序。DMA 控制就是当外设完成数据 I/O 的准备工作之后，会占用总线的一个工作周期，和 RAM 直接交换数据。这个周期之后，CPU又继续控制总线执行原程序。如此反复的，直到整个数据块的数据全部传输完毕，从而解放了CPU。

 DCA (Direct Cache Access)技术通过将目标从内存更改为处理器缓存来改进DMA。这有助于减少I/O延迟，并通过防止数据在内存总线上传输两次来节省内存带宽。DCA是一个通用术语，其实现方式各异。
#### DMA

wy
//TODO:调研报告

 //TODO:DMA和DCA有什么不同，为什么要使用DCA
#### DCA的优势
* `DCA`的优势
  
  * `DCA`显著减少接收密集型网络I/O的**内存延迟和内存带宽**
  * `DCA`可以减少很大一部分的`cache misses`
  * `DCA`技术通过将远程内存数据直接预取到处理器的缓存中，避免了传统访问模式下频繁的内存访问，从而减少了CPU与内存之间的数据传输和访问延迟，提高了**系统的吞吐量和响应速度**。与传统`DMA（Direct Memory Access，直接内存访问）`技术相比，`DCA`技术可以实现更高的效率和性能，同时还能降低系统的负载和功耗

* 通过直接访问CPU缓存中的数据，减少CPU与内存之间的数据传输时间，从而减少了CPU资源的占用。

## 操作系统内核配置
wy
//TODO: 网站6.2.11  图片
## 代码实现

### 调用DCA的基本步骤及相关的头文件

>  [dca.h头文件](https://github.com/torvalds/linux/blob/master/include/linux/dca.h)
> 
>  下面是一些重要的函数、结构体

```cpp
//注册一个DCA提供者的函数
int register_dca_provider(struct dca_provider *dca, struct device *dev);
//注销一个DCA提供者的函数
void unregister_dca_provider(struct dca_provider *dca, struct device *dev);
//结构体
struct dca_provider {
    struct list_head    node;
    const struct dca_ops    *ops;
    struct device         *cd;
    int             id;
};

struct dca_domain {
    struct list_head    node;
    struct list_head    dca_providers;
    struct pci_bus        *pci_rc;
};

struct dca_ops {
    int    (*add_requester)    (struct dca_provider *, struct device *);
    int    (*remove_requester) (struct dca_provider *, struct device *);
    u8    (*get_tag)        (struct dca_provider *, struct device *,
                     int cpu);
    int    (*dev_managed)      (struct dca_provider *, struct device *);
};
//添加一个DCA请求的函数
int dca_add_requester(struct device *dev);
//删除一个DCA请求的函数
int dca_remove_requester(struct device *dev);
```

* **引入头文件**：通常需要引入相关的系统或库文件的头文件，以便在代码中调用相应的函数或接口。例如，在Linux系统中，可以引入**<linux/dca.h>头文件**来使用DCA相关的函数和宏定义。

* **初始化DCA**：需要在程序启动时进行DCA的初始化，以确保DCA功能可以正常使用。通常需要调用相关的函数或接口，例如在Linux系统中，可以使用**dca_sysfs_init()函数**来初始化DCA。

* **配置DCA**：需要根据具体的应用场景和数据访问模式来配置DCA，例如设置预取的数据大小和预取的地址等参数。通常需要使用相应的函数或接口来进行配置，例如在Linux系统中，可以使用**dca3_config()函数**来配置DCA。

* **调用DCA**：在程序运行时，可以使用相应的函数或接口来调用DCA功能，以实现预取数据到缓存中。例如在Linux系统中，可以使用**dca3_get_tag()函数**来执行DCA操作。

## 硬件支持

### 使用Intel的原因

据调研，目前Intel是唯一提供带有DCA支持的商用处理器的供应商
(补充：其他供应商)

### IOAT-DDIO
//TODO:(找官网资料)wrz

## 实验与评估方法

#### 实验步骤

> 1. 挑选适合的linux版本，要求支持DCA。编译内核，勾选相应的DCA支持模块。
> 2. 安装ROS库，用C/C++调用相关库函数实现节点间通信
> 3. 使用智能网卡，实现数据通信的DMA
> 4. 引用`linux/dca.h`等库函数，实现对本地/传输数据0拷贝进入cache，实现DCA
> 5. 找一个i/o密集型，单次处理数据量小的任务，通过系统给出的函数进行计时，测试使用了相关技术前后的时间差异

- 验证方法
  - 对比程序自己编写
  - 数据传输：使用ROS相关的库函数，使用linux DCA库，放进cache计算，IO密集型。
  - 正常的数据传输，用clk粗略计时，比较其他的方案
## 结论

## 参考文献

- [Understanding I/O Direct Cache Access Performance for End Host Networking]( https://dl.acm.org/doi/10.1145/3508042)

***

# 下面是可行性报告的框架

## 1. 背景介绍

- ROS2通信框架及其应用
- 实时性和低延迟通信的需求
- DCA技术介绍及其优势
- NIC与CPU交互

## 2. ROS2通信框架中存在的性能瓶颈

- 运行在Linux上降低了实时性
- ROS2通信框架中可能出现的性能瓶颈
- ROS2通信框架中性能瓶颈与实时性的关系

## 3. DCA技术在ROS2中的应用

- 为什么只能是intel不能是amd

- DCA技术与ROS2通信框架的结合

- DCA技术对ROS2实时性的影响

- DCA技术在ROS2通信中的优化效果
  
  ## 4. 代码实现

- C头文件

- 相关函数介绍 

## 5. 硬件情况

## 6. 实验与评估方法

- 

可能使用的评估方案

## 7. 结论

- 主要结论

## 8. 参考文献

> > > > > > > e7377a8b4a6659e87e5864bf93cfac4d15a33e7e
