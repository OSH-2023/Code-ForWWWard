# 结题报告 Code-ForWWWard

**小组成员**

* 王润泽 PB21020685
* 王道宇 PB21030794
* 封霁芩 PB21111670
* 陈应豪 PB21000117
* 王昱     PB21030814





## 1 项目简介



## 2 项目背景

### 2.1 ROS2

### 2.2 零拷贝技术





## 3 项目设计

### 3.1 项目整体架构

![](./image/structure.png)

### 3.2 技术路线



### 3.3 设计难点

### DCA放弃使用

* `DCA`关不掉，设备支持`DCA`模块即默认打开，如果关掉则会导致与它相关的依赖无法工作。
  ![](image/wy_pic1.png)
  * 我们曾尝试关掉`DCA`模块，结果导致服务器上连包也下载不了，最终只能去实验室重装服务器系统，重新配置服务器

* `grub`文件改内核选项，保存不了也运行不了
* `dca.h`头文件用户态无法调用，只能使用内核态调用。而内核态代码调试困难

### 服务器配置困难

* **帮助我们配置的学长**说这个服务器是很早之前的，服务器本身存在一点问题
* 由于网络并不是我们项目的重点，而配置服务器的`ssh`需要一些网络知识，这导致我们所作的无用功增加，浪费了时间，拖延了项目的进展

### ROS2环境搭建以及零拷贝的实现

* 由于`DCA`宣告失败，我们尝试使用`zero-copy`来优化通信。经过多番尝试，我们利用`iceoryx`这一个中间件，通过调用和改写实现了一个`zero-copy`的`demo`程序



## 4 实验过程

### 4.1 ROS2部署

#### 安装过程

按照官网教程安装ROS2稳定版本`humble`

1. 确保` Ubuntu Universe repository `可用

```bash
sudo apt install software-properties-common
sudo add-apt-repository universe
sudo apt update
```
2. 下载 ROS存储库的 GPG 密钥文件，用于验证 ROS 存储库中的软件包

```bash
sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
```

3. 添加ROS2安装包下载源
```bash
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
sudo apt update
sudo apt upgrade
```

4. 选择安装桌面版或基础版（两条指令执行一条即可）

```bash
sudo apt install ros-humble-desktop  #桌面版
sudo apt install ros-humble-base  #基础版
```

5. 安装其他必备工具（如编译器）
```bash
sudo apt install ros-dev-tools
```

6. 检验是否安装成功：运行demo程序`talker`和`listener`
```bash
source /opt/ros/humble/setup.bash  #可以添加至~/.bashrc，以避免每次新建终端手写（非bash用户需修改后缀）
ros2 run demo_nodes_cpp talker
```

新建另一终端：
```bash
source /opt/ros/humble/setup.bash  #可以添加至~/.bashrc，以避免每次新建终端手写（非bash用户需修改后缀）
ros2 run demo_nodes_py listener
```
无报错出现发布/订阅`Hello World:NUM`即安装成功

#### 工作空间部署
1. 新建文件夹作为所有ROS2 package的根目录：`ros_ws`
2. 将功能包放在`ros_ws/src`中
3. 在根目录下执行编译命令，构建文件结构：
```bash
    #默认编译全部
    ~/ros_ws $ colcon build 
    # 若只需编译某一个package，则执行
    ~/ros_ws $ colcon build --packages-select name_of_package
```

文件结构如图（省略版）
ros_ws
├── ./build
├── ./install
├── ./log
└── ./src
    ├── ./name_of_package1
    └── ./name_of_package2

#### 遇到的问题及解决

1. 下载 ROS存储库的 GPG 密钥文件执行失败（无响应）
解决方法： 手动下载`ros.key`，保存为`/usr/share/keyrings/ros-archive-keyring.gpg`

2. colon build报错：`ModuleNotFoundError: No module named 'catkin_pkg'`

报错情况：
```bash
stderr: name_of_package                         
Traceback (most recent call last):
  File "/opt/ros/humble/share/ament_cmake_core/cmake/core/package_xml_2_cmake.py", line 21, in <module>
    from catkin_pkg.package import parse_package_string
ModuleNotFoundError: No module named 'catkin_pkg'
CMake Error at /opt/ros/humble/share/ament_cmake_core/cmake/core/ament_package_xml.cmake:94 (message):
  execute_process(/home/ros2/miniconda3/bin/python3
  /opt/ros/humble/share/ament_cmake_core/cmake/core/package_xml_2_cmake.py
  /home/ros2/code/ros_ws/src/name_of_package/package.xml
  /home/ros2/code/ros_ws/build/name_of_package/ament_cmake_core/package.cmake)
  returned error code 1
Call Stack (most recent call first):
  /opt/ros/humble/share/ament_cmake_core/cmake/core/ament_package_xml.cmake:49 (_ament_package_xml)
  /opt/ros/humble/share/ament_lint_auto/cmake/ament_lint_auto_find_test_dependencies.cmake:31 (ament_package_xml)
  CMakeLists.txt:34 (ament_lint_auto_find_test_dependencies)
```

解决方法：手动安装`catkin_pkg`
```bash
pip3 install catkin_pkg
```

3. python语言package编译时报错：`SetuptoolsDeprecationWarning: setup.py install is deprecated. Use build and pip`

报错情况：
```bash
--- stderr: helloworld                   
/usr/lib/python3.10/site-packages/setuptools/command/install.py:34: SetuptoolsDeprecationWarning: setup.py install is deprecated. Use build and pip and other standards-based tools.
  warnings.warn(
---
Finished <<< helloworld [0.76s]

Summary: 1 package finished [0.93s]
  1 package had stderr output: helloworld

```
解决方法：
```bash
    #检查使用的setuptools版本，高于58.2.0均报错
    python
    >>> import setuptools
    >>> print("setuptools.__version__")
    59.6.0
    >>> exit()
    pip install setuptools==58.2.0
```


### 4.2 中间件部署

### 



## 5 实验结果



## 6 总结





## 参考文献
