# 调研报告

**初定方向：** 基于ROS2的操作系统实时性优化 

## 小组成员

* 王润泽
* 王道宇
* 封霁芩
* 陈应豪
* 王昱

## 项目背景
#### 时代背景：无人驾驭安全性问题

- 近年来，无人驾驶事故频发，安全性问题已经成为了制约无人驾驶大规模铺设的瓶颈之一。这里有一个典型的例子是：特斯拉在2020年6月台北仙桃发生的事故，车辆在开启自动驾驶的状态下毫无减速的撞上卡车。

  ![](https://mp.ofweek.com/Upload/News/Img/member4608/202006/wx_article_20200601221123_1FQoVh.jpg)

  人身安全至关重要，正因为如此，无人车驾驶的安全问题理应排在首位。要解决像上述的安全问题，一个非常重要的方向就是提高操作系统的实时性。

#### 发展现状

- 百度Apollo

#### 操作系统实时性问题

- 目前计算机主流的方式是将文件读入后先拷贝到内存中，再通过数次拷贝进入cache。等到文件处理完成后，依然需要经过多次拷贝。通过DMA技术和局部性原理，可实现数据0拷贝，降低数据传输消耗的时间，以提升操作系统的实时性。

## 立项依据(理论知识)
### ROS2

* `ROS`(`Robot Operating System`，机器人操作系统)，是专为机器人软件开发所设计出来的一套电脑操作系统架构。它提供类似于操作系统的服务，包括硬件抽象描述、底层驱动程序管理、共用功能的执行、程序间消息传递、程序发行包管理，它也提供一些工具和库用于获取、建立、编写和执行多机融合的程序。事实上，`ROS`并不是一个操作系统，而是编写机器人软件程序的一种具有高度灵活性的分布式软件架构。`ROS`可以分成两层：低层是操作系统层，高层是各类软件包。

#### ROS开发环境

- **gazebo**：一款免费的机器人仿真软件，提供高保真度的物理模拟，一整套传感器模型，以及对用户和程序非常友好的交互方式。能够在复杂的室内和室外环境中准确高效地模拟机器人工作的功能，通常与ROS联合使用，为开发者提供了优异的仿真环境。

#### ROS2中的重要概念

* **节点**：每个节点负责单个模块，**参数**是节点的配置。 
	* `ROS2`与`ROS`比较:`ROS`通过一个核心的`master`节点管理所有节点的通讯 ，如果`master`节点崩溃整个系统会出错；`ROS2`引入了`DDS`(`data distribution service`，数据分发服务)，各个节点可以通过`DDS`进行通信，可以**一对一、一对多、多对多**互相通信，增强了安全性、可靠性，同时提高了实时性。

![](http://dev.ros2.fishros.com/doc/_images/Nodes-TopicandService.gif)


* **话题**：作用是充当节点之间交换信息的总线，它是基于发布者-订阅者模型
  * 话题可以是**一对多、多对一、多对多**的(见下图)

![](http://dev.ros2.fishros.com/doc/_images/Topic-MultiplePublisherandMultipleSubscriber.gif)

* **服务**：服务是基于调用和响应模型的，它会向具体调用的客户端传递数据
  * 一个服务只能有一个服务端，但可以有多个客户端(见下图)

![](http://dev.ros2.fishros.com/doc/_images/Service-MultipleServiceClient.gif)

* **动作**：是由**目标、反馈、结果**三部分组成，是建立在话题、服务之上的。它基于客户端-服务器模型，客户端`NODE`向服务端`NODE`发送**目标**，服务端`NODE`返回**反馈流、结果**
  * 动作与服务类似，但是动作是**可抢占的**。

![](http://dev.ros2.fishros.com/doc/_images/Action-SingleActionClient.gif)

#### ROS2的通信机制

* ***Publish-Subscribe(1)***
  * ***Pub***通过Topic向***Sub***传递数据
  * 该机制常用于连续数据流，数据可以在任何时间独立于任何***Pub***/***Sub***发布和订阅
* ***Service-Client(2)***
  * ***Client***向***Server***发出请求，***Server***执行任务后将response返回给***Client***
  * 该机制常用于快速终止的远程过程调用，不应该用于运行时间较长的进程，特别是，如果发生特殊情况，可能需要抢占的过程。并且它们永远不应改变或依赖于状态，以避免对其他节点产生不必要的副作用
* ***Actions(3)***
  * 基于***Service-Client***，在执行任务时产生了多次Fback
  * 该机制常用于移动机器人或**运行更长时间但在执行过程中提供反馈的任何离散行为**

![](https://pic4.zhimg.com/80/v2-f47656d0346b43d009cc440ba95a2a97_1440w.webp)

#### ROS2与ROS1的区别

* ROS1的不足
  * 仅支持Linux系统
  * 基于TCP/IP的通信方式，点对点的分布式通信机制，实时性差，系统开销大
  * 依赖于ROS master管理所有节点的通讯，稳定性差
  * 对Python3支持不友好
* ROS2的改进
  * 支持Linux、Windows、Mac OS、嵌入式RTOS等，跨平台特性得到改善
  * 引入DDS通信协议，可通过零拷贝的方式传递消息，节约CPU、内存的资源，实时性得到了很大的提升
    * DDS（Data Distribution Service）是一种面向实时通信的消息传递中间件技术，它允许不同设备之间进行实时的、可靠的数据交换。DDS旨在解决数据分发和通信问题，它支持多种编程语言和平台，并提供了高效、安全、可靠的数据交换方式。
    * DDS基于发布-订阅模式（Publish-Subscribe），允许多个发送者（Publishers）同时向多个接收者（Subscribers）广播数据，且能够自动进行数据交换的协商和管理。DDS可以提供实时性能，支持大量的数据量，同时具备高可靠性和安全性。
    * DDS与其他通信技术（如消息队列、WebSocket等）相比，具有更高的实时性、更可靠的通信、更强大的管理和更灵活的数据模型等优势，因此被广泛应用于需要高效实时通信的领域，如工业自动化、航空航天、医疗、智能交通等。
  * 去中心化：去除了ROS master中心节点管理器，节点地位平等，可以**一对一、一对多、多对多**互相通信，稳定性、可靠性得到了很大的提高
  * 支持Python3

### cache

### DMA


## 硬件支持
ROS目前只能在基于Unix的平台上运行，Window版本仍在开发中。ROS的软件主要在Ubuntu和Mac OS X 系统上测试，同时ROS社区仍持续支持Fedora，Gentoo，Arch Linux和其它Linux平台。

我们计划使用较为成熟的Ubuntu作为运行ROS的操作系统，调研相关的可用硬件如下：

### 树莓派Rasperry Pi
- 树莓派是一款基于ARM的微型电脑主板，以SD/MicroSD卡为内存硬盘，卡片主板周围有1/2/4个USB接口和一个10/100 以太网接口，可连接键盘、鼠标和网线，同时拥有视频模拟信号的电视输出接口和HDMI高清视频输出接口，以上部件全部整合在一张仅比信用卡稍大的主板上，具备所有PC的基本功能。
- 树莓派操作系统存储在 SD 卡上，可以进行烧录替换，已找到[Ubuntu镜像资源](https://ubuntu.com/download/raspberry-pi)。

![树莓派4B和树莓派3B的参数对比](./research/image/Raspberry.png)
### STM32

## 重要性分析
- 无人驾驶安全性

  无人驾驶以其智能化、无人化、高效使用城市资源等特点，已经成为了未来发展的必然趋势。然而，近年来由于无人驾驶操作系统处理不及时等问题，已经造成了人员伤亡。想要发展无人驾驶技术，解决相关问题刻不容缓。因此，我们小组希望能对ROS操作系统的实时性进行优化，做到快速处理障碍物信息，快速做出刹车处理，保障人身安全。

- 无人机集群调试

## 相关项目
- OSH-2019-

- OSH-2022-

- OSH-2022-


## 参考文献

[osrf/gazebo_modelsgithub.com/osrf/gazebo_models](https://link.zhihu.com/?target=https%3A//github.com/osrf/gazebo_models)

[(20条消息) NIO进阶篇：Page Cache、零拷贝、顺序读写、堆外内存_p.pagecache关系图_daijiguo的博客-CSDN博客](https://blog.csdn.net/daijiguo/article/details/106457319)

[网卡接收数据流程 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/553904728)

[Wiki-树莓派](https://zh.wikipedia.org/wiki/%E6%A0%91%E8%8E%93%E6%B4%BE)

[ROS2官方文档(中文版)](http://dev.ros2.fishros.com/doc/index.html)

[ROS2 design](http://design.ros2.org/)

[ROS2调度策略](https://zhuanlan.zhihu.com/p/404067881)